#!/usr/bin/env bash

# Update and Install Nginx
echo -e "Updating and installing Nginx.\n"
sudo apt-get update -y -qq && sudo apt-get install nginx -y

# Start Nginx service
echo -e "\nStarting Nginx.\n"
sudo systemctl start nginx
sudo systemctl enable nginx

# Allow Nginx in firewall (if ufw is installed)
if command -v ufw &> /dev/null; then
    sudo ufw allow 'Nginx HTTP'
fi

# Set correct permissions for /var/www
sudo chown -R "$USER":"$USER" /var/www/html
sudo chmod -R 755 /var/www

# Backup default index.html
if [ -f "/var/www/html/index.nginx-debian.html" ]; then
    mv /var/www/html/index.nginx-debian.html /var/www/html/index.nginx-debian.html.bckp
fi

# Create a new index.html
echo "Holberton School" | sudo tee /var/www/html/index.html > /dev/null

# Configure Nginx redirection properly
REDIRECT_CONF="
server {
    listen 80;
    server_name _;

    location /redirect_me {
        return 301 https://www.youtube.com/watch?v=QH2-TGUlwu4;
    }

    location / {
        root /var/www/html;
        index index.html;
    }
}"

echo "$REDIRECT_CONF" | sudo tee /etc/nginx/sites-available/default > /dev/null

# Test Nginx configuration before restarting
sudo nginx -t && sudo systemctl restart nginx

echo -e "\nCompleted."
